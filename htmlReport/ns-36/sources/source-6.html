


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > DatabaseUpdater</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.openmrs.util</a>
</div>

<h1>Coverage Summary for Class: DatabaseUpdater (org.openmrs.util)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DatabaseUpdater</td>
<td class="coverageStat">
  <span class="percent">
    61,5%
  </span>
  <span class="absValue">
    (16/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54,5%
  </span>
  <span class="absValue">
    (146/268)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DatabaseUpdater$OpenMRSChangeSet</td>
<td class="coverageStat">
  <span class="percent">
    53,8%
  </span>
  <span class="absValue">
    (7/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    68,4%
  </span>
  <span class="absValue">
    (13/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DatabaseUpdater$OpenmrsUpdateVisitor</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    61,1%
  </span>
  <span class="absValue">
    (11/18)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    61%
  </span>
  <span class="absValue">
    (25/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    55,7%
  </span>
  <span class="absValue">
    (170/305)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * This Source Code Form is subject to the terms of the Mozilla Public License,
&nbsp; * v. 2.0. If a copy of the MPL was not distributed with this file, You can
&nbsp; * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under
&nbsp; * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.
&nbsp; *
&nbsp; * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS
&nbsp; * graphic logo is a trademark of OpenMRS Inc.
&nbsp; */
&nbsp;package org.openmrs.util;
&nbsp;
&nbsp;import liquibase.Contexts;
&nbsp;import liquibase.GlobalConfiguration;
&nbsp;import liquibase.LabelExpression;
&nbsp;import liquibase.Liquibase;
&nbsp;import liquibase.RuntimeEnvironment;
&nbsp;import liquibase.Scope;
&nbsp;import liquibase.changelog.ChangeLogHistoryServiceFactory;
&nbsp;import liquibase.changelog.ChangeLogIterator;
&nbsp;import liquibase.changelog.ChangeSet;
&nbsp;import liquibase.changelog.DatabaseChangeLog;
&nbsp;import liquibase.changelog.filter.ChangeSetFilterResult;
&nbsp;import liquibase.changelog.filter.ContextChangeSetFilter;
&nbsp;import liquibase.changelog.filter.DbmsChangeSetFilter;
&nbsp;import liquibase.changelog.filter.ShouldRunChangeSetFilter;
&nbsp;import liquibase.changelog.visitor.UpdateVisitor;
&nbsp;import liquibase.command.core.StatusCommandStep;
&nbsp;import liquibase.database.Database;
&nbsp;import liquibase.database.DatabaseFactory;
&nbsp;import liquibase.database.jvm.JdbcConnection;
&nbsp;import liquibase.exception.LiquibaseException;
&nbsp;import liquibase.exception.LockException;
&nbsp;import liquibase.lockservice.LockService;
&nbsp;import liquibase.lockservice.LockServiceFactory;
&nbsp;import liquibase.resource.CompositeResourceAccessor;
&nbsp;import liquibase.resource.FileSystemResourceAccessor;
&nbsp;import liquibase.resource.ResourceAccessor;
&nbsp;import liquibase.ui.LoggerUIService;
&nbsp;import org.apache.commons.io.IOUtils;
&nbsp;import org.openmrs.api.context.Context;
&nbsp;import org.openmrs.liquibase.ChangeLogDetective;
&nbsp;import org.openmrs.liquibase.ChangeLogVersionFinder;
&nbsp;import org.openmrs.liquibase.ChangeSetExecutorCallback;
&nbsp;import org.openmrs.liquibase.LiquibaseProvider;
&nbsp;import org.openmrs.liquibase.LiquibaseScopeHandling;
&nbsp;import org.openmrs.liquibase.OpenmrsClassLoaderResourceAccessor;
&nbsp;import org.openmrs.module.ModuleClassLoader;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import java.io.BufferedWriter;
&nbsp;import java.io.File;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.OutputStreamWriter;
&nbsp;import java.io.PrintWriter;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.DriverManager;
&nbsp;import java.sql.SQLException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Calendar;
&nbsp;import java.util.Date;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.LinkedList;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Properties;
&nbsp;import java.util.Set;
&nbsp;import java.util.logging.Level;
&nbsp;
&nbsp;/**
&nbsp; * This class uses Liquibase to update the database. &lt;br&gt;
&nbsp; * &lt;br&gt;
&nbsp; * See src/main/resources/liquibase-update-to-latest.xml for the changes. This class will also run
&nbsp; * arbitrary liquibase xml files on the associated database as well. Details for the database are
&nbsp; * taken from the openmrs runtime properties.
&nbsp; *
&nbsp; * @since 1.5
&nbsp; */
<b class="fc">&nbsp;public class DatabaseUpdater {</b>
&nbsp;	
<b class="fc">&nbsp;	private static final Logger log = LoggerFactory.getLogger(DatabaseUpdater.class);</b>
&nbsp;	
&nbsp;	private static final String EMPTY_CHANGE_LOG_FILE = &quot;liquibase-empty-changelog.xml&quot;;
&nbsp;	
&nbsp;	public static final String CONTEXT = &quot;core&quot;;
&nbsp;	
&nbsp;	public static final String DATABASE_UPDATES_LOG_FILE = &quot;liquibaseUpdateLogs.txt&quot;;
&nbsp;	
&nbsp;	private static Integer authenticatedUserId;
&nbsp;	
&nbsp;	private static final ChangeLogDetective changeLogDetective;
&nbsp;	
&nbsp;	private static final ChangeLogVersionFinder changeLogVersionFinder;
&nbsp;	
&nbsp;	private static LiquibaseProvider liquibaseProvider;
&nbsp;	
&nbsp;	static {
<b class="fc">&nbsp;		changeLogDetective = new ChangeLogDetective();</b>
<b class="fc">&nbsp;		changeLogVersionFinder = new ChangeLogVersionFinder();</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Allows to inject a LiquibaseProvider instance for testing purposes.
&nbsp;	 * 
&nbsp;	 * @param liquibaseProvider
&nbsp;	 */
&nbsp;	static void setLiquibaseProvider(LiquibaseProvider liquibaseProvider) {
<b class="fc">&nbsp;		DatabaseUpdater.liquibaseProvider = liquibaseProvider;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Removes any LiquibaseProvider instance that was set for testing purposes.
&nbsp;	 */
&nbsp;	static void unsetLiquibaseProvider() {
<b class="fc">&nbsp;		DatabaseUpdater.liquibaseProvider = null;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Holds the update warnings generated by the custom liquibase changesets as they are executed
&nbsp;	 */
<b class="fc">&nbsp;	private static volatile List&lt;String&gt; updateWarnings = null;</b>
&nbsp;	
&nbsp;	/**
&nbsp;	 * Convenience method to run the changesets using Liquibase to bring the database up to a version
&nbsp;	 * compatible with the code
&nbsp;	 */
&nbsp;	public static void executeChangelog() throws DatabaseUpdateException {
<b class="nc">&nbsp;		final LiquibaseProvider liquibaseProvider = new DatabaseUpdaterLiquibaseProvider();</b>
&nbsp;		
&nbsp;		final List&lt;String&gt; changeLogs;
&nbsp;		try {
<b class="nc">&nbsp;			final String version = changeLogDetective.getInitialLiquibaseSnapshotVersion(CONTEXT, liquibaseProvider);</b>
<b class="nc">&nbsp;			log.debug(</b>
&nbsp;				&quot;updating the database with versions of liquibase-update-to-latest files greater than &#39;{}&#39;&quot;,
&nbsp;				version);
&nbsp;			
<b class="nc">&nbsp;			changeLogs = changeLogDetective.getUnrunLiquibaseUpdateFileNames(version, CONTEXT, liquibaseProvider);</b>
<b class="nc">&nbsp;			log.debug(&quot;found applicable Liquibase update change logs: {}&quot;, changeLogs);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception e) {</b>
<b class="nc">&nbsp;			log.error(&quot;Error while trying to find database changes to run&quot;, e);</b>
<b class="nc">&nbsp;			throw new DatabaseUpdateException(&quot;Error while trying to find database changes to run&quot;, e);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;		
<b class="nc">&nbsp;		if (changeLogs.isEmpty()) {</b>
&nbsp;			return;
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		for (String changeLog : changeLogs) {</b>
<b class="nc">&nbsp;			log.debug(&quot;applying Liquibase changelog &#39;{}&#39;&quot;, changeLog);</b>
<b class="nc">&nbsp;			executeChangelog(changeLog, (ChangeSetExecutorCallback) null);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Run changesets on database using Liquibase to get the database up to the most recent version
&nbsp;	 *
&nbsp;	 * @param changelog the liquibase changelog file to use (or null to use the default file)
&nbsp;	 * @param userInput nullable map from question to user answer. Used if a call to update(null) threw
&nbsp;	 *            an {@link InputRequiredException}
&nbsp;	 * @throws DatabaseUpdateException if an error occurs
&nbsp;	 * @deprecated as of 2.4 see {@link #executeChangelog(String, ChangeSetExecutorCallback)}
&nbsp;	 */
&nbsp;	@Deprecated
&nbsp;	public static void executeChangelog(String changelog, Map&lt;String, Object&gt; userInput)
&nbsp;	        throws DatabaseUpdateException {
<b class="nc">&nbsp;		log.debug(&quot;Executing changelog: {}&quot; , changelog);</b>
<b class="nc">&nbsp;		executeChangelog(changelog, (ChangeSetExecutorCallback) null);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Executes the given changelog file. This file is assumed to be on the classpath.
&nbsp;	 *
&nbsp;	 * @param changelog The string filename of a liquibase changelog xml file to run
&nbsp;	 * @return A list of messages or warnings generated by the executed changesets
&nbsp;	 */
&nbsp;	public static List&lt;String&gt; executeChangelog(String changelog, ChangeSetExecutorCallback callback)
&nbsp;	        throws DatabaseUpdateException {
<b class="fc">&nbsp;		log.debug(&quot;installing the tables into the database&quot;);</b>
&nbsp;		
<b class="fc">&nbsp;		if (changelog == null) {</b>
<b class="fc">&nbsp;			throw new IllegalArgumentException(&quot;changelog must not be null&quot;);</b>
&nbsp;		}
&nbsp;		
&nbsp;		try {
<b class="fc">&nbsp;			log.debug(&quot;executing liquibase changelog {}&quot;, changelog);</b>
<b class="fc">&nbsp;			return executeChangelog(changelog, new Contexts(CONTEXT), callback, null);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception e) {</b>
<b class="nc">&nbsp;			throw new DatabaseUpdateException(&quot;There was an error while updating the database to the latest. file: &quot;</b>
<b class="nc">&nbsp;			        + changelog + &quot;. Error: &quot; + e.getMessage(), e);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * This code was borrowed from the liquibase jar so that we can call the given callback function.
&nbsp;	 *
&nbsp;	 * @param changeLogFile the file to execute
&nbsp;	 * @param contexts the liquibase changeset context
&nbsp;	 * @param callback the function to call after every changeset
&nbsp;	 * @return A list of messages or warnings generated by the executed changesets
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	public static List&lt;String&gt; executeChangelog(String changeLogFile, Contexts contexts, ChangeSetExecutorCallback callback,
&nbsp;	        ClassLoader cl) throws Exception {
&nbsp;		
<b class="fc">&nbsp;		if (cl == null) {</b>
<b class="fc">&nbsp;			cl = OpenmrsClassLoader.getInstance();</b>
&nbsp;		}
&nbsp;		
<b class="fc">&nbsp;		Thread.currentThread().setContextClassLoader(cl);</b>
&nbsp;		
<b class="fc">&nbsp;		log.debug(&quot;Setting up liquibase object to run changelog: {}&quot;, changeLogFile);</b>
<b class="fc">&nbsp;		Liquibase liquibase = getLiquibase(changeLogFile, cl);</b>
&nbsp;
<b class="fc">&nbsp;		String scopeId = LiquibaseScopeHandling.enterLiquibaseUILoggingService();</b>
<b class="fc">&nbsp;		int numChangeSetsToRun = new StatusCommandStep()</b>
<b class="fc">&nbsp;			.listUnrunChangeSets(contexts,</b>
<b class="fc">&nbsp;				new LabelExpression(), liquibase.getDatabaseChangeLog(), liquibase.getDatabase()).size();</b>
<b class="fc">&nbsp;		LiquibaseScopeHandling.exitLiquibaseScope(scopeId);</b>
&nbsp;
<b class="fc">&nbsp;		Database database = null;</b>
<b class="fc">&nbsp;		LockService lockHandler = null;</b>
&nbsp;		
&nbsp;		try {
<b class="fc">&nbsp;			database = liquibase.getDatabase();</b>
<b class="fc">&nbsp;			lockHandler = LockServiceFactory.getInstance().getLockService(database);</b>
<b class="fc">&nbsp;			lockHandler.waitForLock();</b>
&nbsp;			
<b class="fc">&nbsp;			DatabaseChangeLog changeLog = liquibase.getDatabaseChangeLog();</b>
<b class="fc">&nbsp;			changeLog.setChangeLogParameters(liquibase.getChangeLogParameters());</b>
<b class="fc">&nbsp;			changeLog.validate(database);</b>
&nbsp;			
<b class="fc">&nbsp;			ChangeLogIterator logIterator = new ChangeLogIterator(changeLog, new ShouldRunChangeSetFilter(database),</b>
&nbsp;			        new ContextChangeSetFilter(contexts), new DbmsChangeSetFilter(database));
&nbsp;			
&nbsp;			// ensure that the change log history service is initialised
&nbsp;			//
<b class="fc">&nbsp;			Scope.getCurrentScope().getSingleton(ChangeLogHistoryServiceFactory.class).getChangeLogService(database).init();</b>
&nbsp;			
<b class="fc">&nbsp;			logIterator.run(new OpenmrsUpdateVisitor(database, callback, numChangeSetsToRun),</b>
&nbsp;			    new RuntimeEnvironment(database, contexts, new LabelExpression()));
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			try {</b>
<b class="fc">&nbsp;				if (lockHandler != null) {</b>
<b class="fc">&nbsp;					lockHandler.releaseLock();</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
<b class="nc">&nbsp;				log.error(&quot;Could not release lock&quot;, e);</b>
<b class="fc">&nbsp;			}</b>
&nbsp;
&nbsp;			try {
<b class="fc">&nbsp;				if (database != null &amp;&amp; database.getConnection() != null) {</b>
<b class="fc">&nbsp;					database.getConnection().close();</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
&nbsp;				//pass
<b class="fc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;		
<b class="fc">&nbsp;		return updateWarnings;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Ask Liquibase if it needs to do any updates.
&nbsp;	 *
&nbsp;	 * @return true/false whether database updates are required
&nbsp;	 * @throws Exception when an exception is raised while processing Liquibase changelog files
&nbsp;	 */
&nbsp;	public static boolean updatesRequired() throws Exception {
<b class="fc">&nbsp;		log.debug(&quot;checking for updates&quot;);</b>
<b class="fc">&nbsp;		List&lt;OpenMRSChangeSet&gt; changesets = getUnrunDatabaseChanges(new DatabaseUpdaterLiquibaseProvider());</b>
&nbsp;		
&nbsp;		// if the db is locked, it means there was a crash
&nbsp;		// or someone is executing db updates right now. either way
&nbsp;		// returning true here stops the openmrs startup and shows
&nbsp;		// the user the maintenance wizard for updates
<b class="fc">&nbsp;		if (isLocked() &amp;&amp; changesets.isEmpty()) {</b>
&nbsp;			// if there is a db lock but there are no db changes we undo the
&nbsp;			// lock
<b class="nc">&nbsp;			DatabaseUpdater.releaseDatabaseLock();</b>
<b class="nc">&nbsp;			log.debug(&quot;db lock found and released automatically&quot;);</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
&nbsp;		
<b class="fc">&nbsp;		return !changesets.isEmpty();</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Ask Liquibase if it needs to do any updates
&nbsp;	 *
&nbsp;	 * @param changeLogFilenames the filenames of all files to search for unrun changesets
&nbsp;	 * @return true/false whether database updates are required &lt;strong&gt;Should&lt;/strong&gt; always have a
&nbsp;	 *         valid update to latest file
&nbsp;	 */
&nbsp;	public static boolean updatesRequired(String... changeLogFilenames) throws Exception {
<b class="nc">&nbsp;		log.debug(&quot;checking for updates&quot;);</b>
<b class="nc">&nbsp;		List&lt;OpenMRSChangeSet&gt; changesets = getUnrunDatabaseChanges(changeLogFilenames);</b>
<b class="nc">&nbsp;		return !changesets.isEmpty();</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Indicates whether automatic database updates are allowed by this server. Automatic updates are
&nbsp;	 * disabled by default. In order to enable automatic updates, the admin needs to add
&nbsp;	 * &#39;auto_update_database=true&#39; to the runtime properties file.
&nbsp;	 *
&nbsp;	 * @return true/false whether the &#39;auto_update_database&#39; has been enabled.
&nbsp;	 */
&nbsp;	public static Boolean allowAutoUpdate() {
<b class="nc">&nbsp;		String allowAutoUpdate = Context.getRuntimeProperties()</b>
<b class="nc">&nbsp;		        .getProperty(OpenmrsConstants.AUTO_UPDATE_DATABASE_RUNTIME_PROPERTY, &quot;false&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		return &quot;true&quot;.equals(allowAutoUpdate);</b>
&nbsp;		
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Takes the default properties defined in /metadata/api/hibernate/hibernate.default.properties and
&nbsp;	 * merges it into the user-defined runtime properties
&nbsp;	 *
&nbsp;	 * @see org.openmrs.api.db.ContextDAO#mergeDefaultRuntimeProperties(Properties)
&nbsp;	 */
&nbsp;	private static void mergeDefaultRuntimeProperties(Properties runtimeProperties) {
&nbsp;		
&nbsp;		// loop over runtime properties and precede each with &quot;hibernate&quot; if
&nbsp;		// it isn&#39;t already
&nbsp;		// must do it this way to prevent concurrent mod errors
<b class="fc">&nbsp;		Set&lt;Object&gt; runtimePropertyKeys = new HashSet&lt;&gt;(runtimeProperties.keySet());</b>
<b class="fc">&nbsp;		for (Object key : runtimePropertyKeys) {</b>
<b class="fc">&nbsp;			String prop = (String) key;</b>
<b class="fc">&nbsp;			String value = (String) runtimeProperties.get(key);</b>
<b class="fc">&nbsp;			log.trace(&quot;Setting property: &quot; + prop + &quot;:&quot; + value);</b>
<b class="fc">&nbsp;			if (!prop.startsWith(&quot;hibernate&quot;) &amp;&amp; !runtimeProperties.containsKey(&quot;hibernate.&quot; + prop)) {</b>
<b class="fc">&nbsp;				runtimeProperties.setProperty(&quot;hibernate.&quot; + prop, value);</b>
&nbsp;			}
<b class="fc">&nbsp;		}</b>
&nbsp;		
&nbsp;		// load in the default hibernate properties from hibernate.default.properties
<b class="fc">&nbsp;		InputStream propertyStream = null;</b>
&nbsp;		try {
<b class="fc">&nbsp;			Properties props = new Properties();</b>
&nbsp;			// TODO: This is a dumb requirement to have hibernate in here.  Clean this up
<b class="fc">&nbsp;			propertyStream = DatabaseUpdater.class.getClassLoader().getResourceAsStream(&quot;hibernate.default.properties&quot;);</b>
<b class="fc">&nbsp;			OpenmrsUtil.loadProperties(props, propertyStream);</b>
&nbsp;			// add in all default properties that don&#39;t exist in the runtime
&nbsp;			// properties yet
<b class="fc">&nbsp;			for (Map.Entry&lt;Object, Object&gt; entry : props.entrySet()) {</b>
<b class="fc">&nbsp;				if (!runtimeProperties.containsKey(entry.getKey())) {</b>
<b class="fc">&nbsp;					runtimeProperties.put(entry.getKey(), entry.getValue());</b>
&nbsp;				}
<b class="fc">&nbsp;			}</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			try {</b>
<b class="fc">&nbsp;				propertyStream.close();</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
&nbsp;				// pass
<b class="fc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Exposes Liquibase instances created by this class. When calling
&nbsp;	 * org.openmrs.util.DatabaseUpdater#getInitialLiquibaseSnapshotVersion(LiquibaseProvider) and
&nbsp;	 * org.openmrs.util.DatabaseUpdater#getInitialLiquibaseSnapshotVersion(String,LiquibaseProvider), a
&nbsp;	 * Liquibase instance created by this class is injected into these methods. The Liquibase instance
&nbsp;	 * is injected into these methods instead of calling
&nbsp;	 * org.openmrs.util.DatabaseUpdater#getLiquibase(String,ClassLoader) directly. The reason for that
&nbsp;	 * design decision is that injecting a Liquibase instance (via a Liquibase provider) makes it
&nbsp;	 * possible to test the two methods mentioned above in isolation. The respective integration test is
&nbsp;	 * org.openmrs.util.DatabaseUpdateIT.
&nbsp;	 * 
&nbsp;	 * @see LiquibaseProvider
&nbsp;	 * @param changeLogFile name of a Liquibase change log file
&nbsp;	 * @return a Liquibase instance
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	static Liquibase getLiquibase(String changeLogFile) throws Exception {
<b class="fc">&nbsp;		if (liquibaseProvider != null) {</b>
<b class="fc">&nbsp;			return liquibaseProvider.getLiquibase(changeLogFile);</b>
&nbsp;		}
<b class="fc">&nbsp;		return getLiquibase(changeLogFile, OpenmrsClassLoader.getInstance());</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Get a connection to the database through Liquibase. The calling method /must/ close the database
&nbsp;	 * connection when finished with this Liquibase object.
&nbsp;	 * liquibase.getDatabase().getConnection().close()
&nbsp;	 *
&nbsp;	 * @param changeLogFile the name of the file to look for the on classpath or filesystem
&nbsp;	 * @param cl the {@link ClassLoader} to use to find the file (or null to use
&nbsp;	 *            {@link OpenmrsClassLoader})
&nbsp;	 * @return Liquibase object based on the current connection settings
&nbsp;	 * @throws Exception
&nbsp;	 */
&nbsp;	private static Liquibase getLiquibase(String changeLogFile, ClassLoader cl) throws Exception {
&nbsp;		Connection connection;
&nbsp;		try {
<b class="fc">&nbsp;			connection = getConnection();</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (SQLException e) {</b>
<b class="nc">&nbsp;			throw new Exception(</b>
&nbsp;			        &quot;Unable to get a connection to the database.  Please check your openmrs runtime properties file and make sure you have the correct connection.username and connection.password set&quot;,
&nbsp;			        e);
<b class="fc">&nbsp;		}</b>
&nbsp;		
<b class="fc">&nbsp;		if (cl == null) {</b>
<b class="fc">&nbsp;			cl = OpenmrsClassLoader.getInstance();</b>
&nbsp;		}
&nbsp;		
&nbsp;		try {
<b class="fc">&nbsp;			Database database = DatabaseFactory.getInstance()</b>
<b class="fc">&nbsp;			        .findCorrectDatabaseImplementation(new JdbcConnection(connection));</b>
<b class="fc">&nbsp;			database.setDatabaseChangeLogTableName(&quot;liquibasechangelog&quot;);</b>
<b class="fc">&nbsp;			database.setDatabaseChangeLogLockTableName(&quot;liquibasechangeloglock&quot;);</b>
&nbsp;			
<b class="fc">&nbsp;			if (connection.getMetaData().getDatabaseProductName().contains(&quot;HSQL Database Engine&quot;)</b>
<b class="fc">&nbsp;			        || connection.getMetaData().getDatabaseProductName().contains(&quot;H2&quot;)) {</b>
&nbsp;				// a hack because hsqldb and h2 seem to be checking table names in the metadata section case sensitively
<b class="fc">&nbsp;				database.setDatabaseChangeLogTableName(database.getDatabaseChangeLogTableName().toUpperCase());</b>
<b class="fc">&nbsp;				database.setDatabaseChangeLogLockTableName(database.getDatabaseChangeLogLockTableName().toUpperCase());</b>
&nbsp;			}
&nbsp;
<b class="fc">&nbsp;			if (changeLogFile == null) {</b>
<b class="fc">&nbsp;				changeLogFile = EMPTY_CHANGE_LOG_FILE;</b>
&nbsp;			}
&nbsp;
<b class="fc">&nbsp;			configureLiquibaseDuplicateFileMode();</b>
&nbsp;
&nbsp;			// ensure that the change log history service is initialised
<b class="fc">&nbsp;			Scope.getCurrentScope()</b>
<b class="fc">&nbsp;				.getSingleton(ChangeLogHistoryServiceFactory.class)</b>
<b class="fc">&nbsp;				.getChangeLogService(database)</b>
<b class="fc">&nbsp;				.init();</b>
<b class="fc">&nbsp;			return new Liquibase(changeLogFile, getCompositeResourceAccessor(cl), database);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception e) {</b>
&nbsp;			// if an error occurs, close the connection
<b class="nc">&nbsp;			if (connection != null) {</b>
<b class="nc">&nbsp;				connection.close();</b>
&nbsp;			}
<b class="nc">&nbsp;			throw e;</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Gets a database connection for liquibase to do the updates
&nbsp;	 *
&nbsp;	 * @return a java.sql.connection based on the current runtime properties
&nbsp;	 */
&nbsp;	public static Connection getConnection() throws Exception {
<b class="fc">&nbsp;		Properties props = Context.getRuntimeProperties();</b>
<b class="fc">&nbsp;		mergeDefaultRuntimeProperties(props);</b>
&nbsp;		
<b class="fc">&nbsp;		String driver = props.getProperty(&quot;hibernate.connection.driver_class&quot;);</b>
<b class="fc">&nbsp;		String username = props.getProperty(&quot;hibernate.connection.username&quot;);</b>
<b class="fc">&nbsp;		String password = props.getProperty(&quot;hibernate.connection.password&quot;);</b>
<b class="fc">&nbsp;		String url = props.getProperty(&quot;hibernate.connection.url&quot;);</b>
&nbsp;		
&nbsp;		// hack for mysql to make sure innodb tables are created
<b class="fc">&nbsp;		if (url.contains(&quot;mysql&quot;) &amp;&amp; !url.contains(&quot;InnoDB&quot;)) {</b>
<b class="nc">&nbsp;			url = url + &quot;&amp;sessionVariables=default_storage_engine=InnoDB&quot;;</b>
&nbsp;		}
&nbsp;		
<b class="fc">&nbsp;		Class.forName(driver);</b>
<b class="fc">&nbsp;		return DriverManager.getConnection(url, username, password);</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Represents each change in the files referenced by liquibase-update-to-latest
&nbsp;	 */
&nbsp;	public static class OpenMRSChangeSet {
&nbsp;		
&nbsp;		private String id;
&nbsp;		
&nbsp;		private String author;
&nbsp;		
&nbsp;		private String comments;
&nbsp;		
&nbsp;		private String description;
&nbsp;		
&nbsp;		private ChangeSet.RunStatus runStatus;
&nbsp;		
&nbsp;		private Date ranDate;
&nbsp;		
&nbsp;		/**
&nbsp;		 * Create an OpenmrsChangeSet from the given changeset
&nbsp;		 *
&nbsp;		 * @param changeSet
&nbsp;		 * @param database
&nbsp;		 */
<b class="fc">&nbsp;		public OpenMRSChangeSet(ChangeSet changeSet, Database database) throws Exception {</b>
<b class="fc">&nbsp;			setId(changeSet.getId());</b>
<b class="fc">&nbsp;			setAuthor(changeSet.getAuthor());</b>
<b class="fc">&nbsp;			setComments(changeSet.getComments());</b>
<b class="fc">&nbsp;			setDescription(changeSet.getDescription());</b>
<b class="fc">&nbsp;			setRunStatus(database.getRunStatus(changeSet));</b>
<b class="fc">&nbsp;			setRanDate(database.getRanDate(changeSet));</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the author
&nbsp;		 */
&nbsp;		public String getAuthor() {
<b class="nc">&nbsp;			return author;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param author the author to set
&nbsp;		 */
&nbsp;		public void setAuthor(String author) {
<b class="fc">&nbsp;			this.author = author;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the comments
&nbsp;		 */
&nbsp;		public String getComments() {
<b class="nc">&nbsp;			return comments;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param comments the comments to set
&nbsp;		 */
&nbsp;		public void setComments(String comments) {
<b class="fc">&nbsp;			this.comments = comments;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the description
&nbsp;		 */
&nbsp;		public String getDescription() {
<b class="nc">&nbsp;			return description;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param description the description to set
&nbsp;		 */
&nbsp;		public void setDescription(String description) {
<b class="fc">&nbsp;			this.description = description;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the runStatus
&nbsp;		 */
&nbsp;		public ChangeSet.RunStatus getRunStatus() {
<b class="nc">&nbsp;			return runStatus;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param runStatus the runStatus to set
&nbsp;		 */
&nbsp;		public void setRunStatus(ChangeSet.RunStatus runStatus) {
<b class="fc">&nbsp;			this.runStatus = runStatus;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the ranDate
&nbsp;		 */
&nbsp;		public Date getRanDate() {
<b class="nc">&nbsp;			return ranDate;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param ranDate the ranDate to set
&nbsp;		 */
&nbsp;		public void setRanDate(Date ranDate) {
<b class="fc">&nbsp;			this.ranDate = ranDate;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @return the id
&nbsp;		 */
&nbsp;		public String getId() {
<b class="nc">&nbsp;			return id;</b>
&nbsp;		}
&nbsp;		
&nbsp;		/**
&nbsp;		 * @param id the id to set
&nbsp;		 */
&nbsp;		public void setId(String id) {
<b class="fc">&nbsp;			this.id = id;</b>
&nbsp;		}
&nbsp;		
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Returns all change sets defined by (a) the Liquibase snapshot files that had been used to
&nbsp;	 * initialise the OpenMRS database and (b) the Liquibase update files that that are applicable on
&nbsp;	 * top of the snapshot version.
&nbsp;	 * 
&nbsp;	 * @return list of change sets that both have and haven&#39;t been run
&nbsp;	 */
&nbsp;	public static List&lt;OpenMRSChangeSet&gt; getDatabaseChanges() throws Exception {
<b class="nc">&nbsp;		if (Context.isSessionOpen()) { // Do not check privileges if not run in webapp context (e.g. in tests)</b>
<b class="nc">&nbsp;			Context.requirePrivilege(PrivilegeConstants.GET_DATABASE_CHANGES);</b>
&nbsp;		}
<b class="nc">&nbsp;		List&lt;OpenMRSChangeSet&gt; result = new ArrayList&lt;&gt;();</b>
&nbsp;		
<b class="nc">&nbsp;		String initialSnapshotVersion = changeLogDetective.getInitialLiquibaseSnapshotVersion(CONTEXT,</b>
&nbsp;		    new DatabaseUpdaterLiquibaseProvider());
<b class="nc">&nbsp;		List&lt;String&gt; updateVersions = changeLogVersionFinder.getUpdateVersionsGreaterThan(initialSnapshotVersion);</b>
&nbsp;		
<b class="nc">&nbsp;		Map&lt;String, List&lt;String&gt;&gt; snapshotCombinations = changeLogVersionFinder.getSnapshotCombinations();</b>
&nbsp;
<b class="nc">&nbsp;		List&lt;String&gt; changeLogFileNames = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		changeLogFileNames.addAll(snapshotCombinations.get(initialSnapshotVersion));</b>
<b class="nc">&nbsp;		changeLogFileNames.addAll(changeLogVersionFinder.getUpdateFileNames(updateVersions));</b>
&nbsp;		
<b class="nc">&nbsp;		Liquibase liquibase = null;</b>
&nbsp;		try {
<b class="nc">&nbsp;			for (String filename : changeLogFileNames) {</b>
<b class="nc">&nbsp;				String scopeId = LiquibaseScopeHandling.enterLiquibaseUILoggingService();</b>
<b class="nc">&nbsp;				liquibase = getLiquibase(filename);</b>
<b class="nc">&nbsp;				List&lt;ChangeSet&gt; changeSets = liquibase.getDatabaseChangeLog().getChangeSets();</b>
&nbsp;				
<b class="nc">&nbsp;				for (ChangeSet changeSet : changeSets) {</b>
<b class="nc">&nbsp;					OpenMRSChangeSet openMRSChangeSet = new OpenMRSChangeSet(changeSet, liquibase.getDatabase());</b>
<b class="nc">&nbsp;					result.add(openMRSChangeSet);</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;				LiquibaseScopeHandling.exitLiquibaseScope(scopeId);</b>
<b class="nc">&nbsp;				liquibase.close();</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			if (liquibase != null) {</b>
&nbsp;				try {
<b class="nc">&nbsp;					liquibase.close();</b>
&nbsp;				}
<b class="nc">&nbsp;				catch (Exception e) {</b>
&nbsp;					// ignore exceptions triggered by closing liquibase a second time 
<b class="nc">&nbsp;				}</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
&nbsp;		
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Returns a list of Liquibase change sets were not run yet.
&nbsp;	 *
&nbsp;	 * @param liquibaseProvider provides access to a Liquibase instance
&nbsp;	 * @return list of change sets that were not run yet.
&nbsp;	 */
&nbsp;	public static List&lt;OpenMRSChangeSet&gt; getUnrunDatabaseChanges(LiquibaseProvider liquibaseProvider) throws Exception {
<b class="fc">&nbsp;		if (Context.isSessionOpen()) { // Do not check privileges if not run in webapp context (e.g. in tests)</b>
<b class="fc">&nbsp;			Context.requirePrivilege(PrivilegeConstants.GET_DATABASE_CHANGES);</b>
&nbsp;		}
<b class="fc">&nbsp;		String initialSnapshotVersion = changeLogDetective.getInitialLiquibaseSnapshotVersion(CONTEXT, liquibaseProvider);</b>
<b class="fc">&nbsp;		log.debug(&quot;initial snapshot version is &#39;{}&#39;&quot;, initialSnapshotVersion);</b>
&nbsp;		
<b class="fc">&nbsp;		List&lt;String&gt; liquibaseUpdateFilenames = changeLogDetective.getUnrunLiquibaseUpdateFileNames(initialSnapshotVersion,</b>
&nbsp;		    CONTEXT, liquibaseProvider);
&nbsp;		
<b class="fc">&nbsp;		if (!liquibaseUpdateFilenames.isEmpty()) {</b>
<b class="fc">&nbsp;			return getUnrunDatabaseChanges(liquibaseUpdateFilenames.toArray(new String[0]));</b>
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		return new ArrayList&lt;OpenMRSChangeSet&gt;();</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Looks at the specified liquibase change log files and returns all changesets in the files that
&nbsp;	 * have not been run on the database yet. If no argument is specified, then it looks at the current
&nbsp;	 * liquibase-update-to-latest.xml file
&nbsp;	 *
&nbsp;	 * @param changeLogFilenames the filenames of all files to search for unrun changesets
&nbsp;	 * @return list of change sets
&nbsp;	 */
&nbsp;	public static List&lt;OpenMRSChangeSet&gt; getUnrunDatabaseChanges(String... changeLogFilenames) {
<b class="fc">&nbsp;		if (Context.isSessionOpen()) { // Do not check privileges if not run in webapp context (e.g. in tests)</b>
<b class="fc">&nbsp;			Context.requirePrivilege(PrivilegeConstants.GET_DATABASE_CHANGES);</b>
&nbsp;		}
<b class="fc">&nbsp;		log.debug(&quot;looking for un-run change sets in &#39;{}&#39;&quot;, Arrays.toString(changeLogFilenames));</b>
&nbsp;		
<b class="fc">&nbsp;		Database database = null;</b>
&nbsp;		try {
<b class="fc">&nbsp;			if (changeLogFilenames == null || changeLogFilenames.length == 0) {</b>
<b class="fc">&nbsp;				throw new IllegalArgumentException(&quot;changeLogFilenames can neither null nor an empty array&quot;);</b>
&nbsp;			}
&nbsp;			
<b class="fc">&nbsp;			List&lt;OpenMRSChangeSet&gt; results = new ArrayList&lt;&gt;();</b>
&nbsp;			
<b class="fc">&nbsp;			String scopeId = LiquibaseScopeHandling.enterLiquibaseUILoggingService();</b>
<b class="fc">&nbsp;			for (String changelogFile : changeLogFilenames) {</b>
<b class="fc">&nbsp;				Liquibase liquibase = getLiquibase(changelogFile, null);</b>
<b class="fc">&nbsp;				database = liquibase.getDatabase();</b>
&nbsp;				
<b class="fc">&nbsp;				List&lt;ChangeSet&gt; changeSets = new StatusCommandStep()</b>
<b class="fc">&nbsp;					.listUnrunChangeSets(new Contexts(CONTEXT),</b>
<b class="fc">&nbsp;						new LabelExpression(), liquibase.getDatabaseChangeLog(), liquibase.getDatabase());</b>
&nbsp;
<b class="fc">&nbsp;				for (ChangeSet changeSet : changeSets) {</b>
<b class="fc">&nbsp;					OpenMRSChangeSet omrschangeset = new OpenMRSChangeSet(changeSet, database);</b>
<b class="fc">&nbsp;					results.add(omrschangeset);</b>
<b class="fc">&nbsp;				}</b>
&nbsp;			}
&nbsp;			
<b class="fc">&nbsp;			LiquibaseScopeHandling.exitLiquibaseScope(scopeId);</b>
<b class="fc">&nbsp;			return results;</b>
&nbsp;			
&nbsp;		}
<b class="fc">&nbsp;		catch (Exception e) {</b>
<b class="fc">&nbsp;			throw new RuntimeException(</b>
<b class="fc">&nbsp;			        &quot;Error occurred while trying to get the updates needed for the database. &quot; + e.getMessage(), e);</b>
&nbsp;		}
&nbsp;		finally {
<b class="fc">&nbsp;			try {</b>
<b class="fc">&nbsp;				database.getConnection().close();</b>
&nbsp;			}
<b class="fc">&nbsp;			catch (Exception e) {</b>
&nbsp;				//pass
<b class="fc">&nbsp;			}</b>
<b class="fc">&nbsp;		}</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * @return the authenticatedUserId
&nbsp;	 */
&nbsp;	public static Integer getAuthenticatedUserId() {
<b class="nc">&nbsp;		return authenticatedUserId;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * @param userId the authenticatedUserId to set
&nbsp;	 */
&nbsp;	public static void setAuthenticatedUserId(Integer userId) {
<b class="nc">&nbsp;		authenticatedUserId = userId;</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * This method is called by an executing custom changeset to register warning messages.
&nbsp;	 *
&nbsp;	 * @param warnings list of warnings to append to the end of the current list
&nbsp;	 */
&nbsp;	public static void reportUpdateWarnings(List&lt;String&gt; warnings) {
<b class="nc">&nbsp;		if (updateWarnings == null) {</b>
<b class="nc">&nbsp;			updateWarnings = new LinkedList&lt;&gt;();</b>
&nbsp;		}
<b class="nc">&nbsp;		updateWarnings.addAll(warnings);</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * This method writes the given text to the database updates log file located in the application
&nbsp;	 * data directory.
&nbsp;	 *
&nbsp;	 * @param text text to be written to the file
&nbsp;	 */
&nbsp;	public static void writeUpdateMessagesToFile(String text) {
<b class="nc">&nbsp;		OutputStreamWriter streamWriter = null;</b>
<b class="nc">&nbsp;		PrintWriter writer = null;</b>
<b class="nc">&nbsp;		File destFile = new File(OpenmrsUtil.getApplicationDataDirectory(), DatabaseUpdater.DATABASE_UPDATES_LOG_FILE);</b>
&nbsp;		try {
<b class="nc">&nbsp;			String lineSeparator = System.getProperty(&quot;line.separator&quot;);</b>
<b class="nc">&nbsp;			Date date = Calendar.getInstance().getTime();</b>
&nbsp;			
<b class="nc">&nbsp;			streamWriter = new OutputStreamWriter(new FileOutputStream(destFile, true), StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;			writer = new PrintWriter(new BufferedWriter(streamWriter));</b>
<b class="nc">&nbsp;			writer.write(&quot;********** START OF DATABASE UPDATE LOGS AS AT &quot; + date + &quot; **********&quot;);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
<b class="nc">&nbsp;			writer.write(text);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
<b class="nc">&nbsp;			writer.write(&quot;*********** END OF DATABASE UPDATE LOGS AS AT &quot; + date + &quot; ***********&quot;);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
<b class="nc">&nbsp;			writer.write(lineSeparator);</b>
&nbsp;			
&nbsp;			//check if there was an error while writing to the file
<b class="nc">&nbsp;			if (writer.checkError()) {</b>
<b class="nc">&nbsp;				log.warn(&quot;An Error occured while writing warnings to the database update log file&#39;&quot;);</b>
&nbsp;			}
&nbsp;			
<b class="nc">&nbsp;			writer.close();</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (FileNotFoundException e) {</b>
<b class="nc">&nbsp;			log.warn(&quot;Failed to find the database update log file&quot;, e);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IOException e) {</b>
<b class="nc">&nbsp;			log.warn(&quot;Failed to write to the database update log file&quot;, e);</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			IOUtils.closeQuietly(streamWriter);</b>
<b class="nc">&nbsp;			IOUtils.closeQuietly(writer);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * This method releases the liquibase db lock after a crashed database update. First, it checks
&nbsp;	 * whether &quot;liquibasechangeloglock&quot; table exists in db. If so, it will check whether the database is
&nbsp;	 * locked. If that is also true, this means that last attempted db update crashed.&lt;br&gt;
&nbsp;	 * &lt;br&gt;
&nbsp;	 * This should only be called if the user is sure that no one else is currently running database
&nbsp;	 * updates. This method should be used if there was a db crash while updates were being written and
&nbsp;	 * the lock table was never cleaned up.
&nbsp;	 *
&nbsp;	 * @throws LockException
&nbsp;	 */
&nbsp;	public static synchronized void releaseDatabaseLock() throws LockException {
<b class="nc">&nbsp;		Database database = null;</b>
&nbsp;		
&nbsp;		try {
<b class="nc">&nbsp;			Liquibase liquibase = getLiquibase(null, null);</b>
<b class="nc">&nbsp;			database = liquibase.getDatabase();</b>
<b class="nc">&nbsp;			LockService lockService = LockServiceFactory.getInstance().getLockService(database);</b>
<b class="nc">&nbsp;			if (lockService.hasChangeLogLock() &amp;&amp; isLocked()) {</b>
<b class="nc">&nbsp;				lockService.forceReleaseLock();</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception e) {</b>
<b class="nc">&nbsp;			throw new LockException(e);</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			try {</b>
<b class="nc">&nbsp;				database.getConnection().close();</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
&nbsp;				// pass
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * This method currently checks the liquibasechangeloglock table to see if there is a row with a
&nbsp;	 * lock in it. This uses the liquibase API to do this
&nbsp;	 *
&nbsp;	 * @return true if database is currently locked
&nbsp;	 */
&nbsp;	public static boolean isLocked() {
<b class="fc">&nbsp;		Database database = null;</b>
&nbsp;		try {
<b class="fc">&nbsp;			Liquibase liquibase = getLiquibase(null, null);</b>
<b class="fc">&nbsp;			database = liquibase.getDatabase();</b>
<b class="fc">&nbsp;			return LockServiceFactory.getInstance().getLockService(database).listLocks().length &gt; 0;</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception e) {</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			try {</b>
<b class="fc">&nbsp;				database.getConnection().close();</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
&nbsp;				// pass
<b class="fc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private final static class OpenmrsUpdateVisitor extends UpdateVisitor {
&nbsp;
&nbsp;		private final ChangeSetExecutorCallback callback;
&nbsp;
&nbsp;		private final int numChangeSetsToRun;
&nbsp;
&nbsp;		public OpenmrsUpdateVisitor(Database database, ChangeSetExecutorCallback callback, int numChangeSetsToRun) {
<b class="fc">&nbsp;			super(database, null);</b>
<b class="fc">&nbsp;			this.callback = callback;</b>
<b class="fc">&nbsp;			this.numChangeSetsToRun = numChangeSetsToRun;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void visit(ChangeSet changeSet, DatabaseChangeLog databaseChangeLog, Database database,
&nbsp;			Set&lt;ChangeSetFilterResult&gt; filterResults) throws LiquibaseException {
<b class="fc">&nbsp;			if (callback != null) {</b>
<b class="nc">&nbsp;				callback.executing(changeSet, numChangeSetsToRun);</b>
&nbsp;			}
<b class="fc">&nbsp;			Map&lt;String, Object&gt; scopeValues = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;			scopeValues.put(Scope.Attr.resourceAccessor.name(), getCompositeResourceAccessor(null));</b>
<b class="fc">&nbsp;			String scopeId = null;</b>
&nbsp;			try {
<b class="fc">&nbsp;				scopeId = Scope.enter(scopeValues);</b>
<b class="fc">&nbsp;				super.visit(changeSet, databaseChangeLog, database, filterResults);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception e) {</b>
<b class="nc">&nbsp;				throw new LiquibaseException(&quot;Unable to execute change set: &quot; + changeSet, e);</b>
&nbsp;			}
&nbsp;			finally {
<b class="nc">&nbsp;				try {</b>
<b class="fc">&nbsp;					Scope.exit(scopeId);</b>
&nbsp;				}
<b class="nc">&nbsp;				catch (Exception e) {</b>
<b class="nc">&nbsp;					log.warn(&quot;An error occurred trying to exit the liquibase scope&quot;, e);</b>
<b class="fc">&nbsp;				}</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * @return a resourceAccessor that includes both classpath and filesystem at the application data directory
&nbsp;	 */
&nbsp;	private static CompositeResourceAccessor getCompositeResourceAccessor(ClassLoader classLoader) {
<b class="fc">&nbsp;		if (classLoader == null) {</b>
<b class="fc">&nbsp;			classLoader = Thread.currentThread().getContextClassLoader();</b>
<b class="fc">&nbsp;			if (!(classLoader instanceof OpenmrsClassLoader) &amp;&amp; !(classLoader instanceof ModuleClassLoader)) {</b>
<b class="nc">&nbsp;				classLoader = OpenmrsClassLoader.getInstance();</b>
&nbsp;			}
&nbsp;		}
&nbsp;		
<b class="fc">&nbsp;		ResourceAccessor openmrsFO = new OpenmrsClassLoaderResourceAccessor(classLoader);</b>
<b class="fc">&nbsp;		ResourceAccessor fsFO = new FileSystemResourceAccessor(OpenmrsUtil.getApplicationDataDirectoryAsFile());</b>
<b class="fc">&nbsp;		return new CompositeResourceAccessor(openmrsFO, fsFO);</b>
&nbsp;	}
&nbsp;	
&nbsp;	private static void configureLiquibaseDuplicateFileMode() {
<b class="fc">&nbsp;		final String dupFlagModeKey = GlobalConfiguration.DUPLICATE_FILE_MODE.getKey();</b>
<b class="fc">&nbsp;		final String dupFlagMode = Context.getRuntimeProperties().getProperty(dupFlagModeKey);</b>
&nbsp;
<b class="fc">&nbsp;		if (dupFlagMode != null) {</b>
<b class="nc">&nbsp;			System.setProperty(dupFlagModeKey, dupFlagMode);</b>
<b class="fc">&nbsp;		} else if (System.getProperty(dupFlagModeKey) == null) {</b>
<b class="fc">&nbsp;			System.setProperty(dupFlagModeKey, OpenmrsConstants.LIQUIBASE_DUPLICATE_FILE_MODE_DEFAULT);</b>
&nbsp;		}
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-09-19 11:27</div>
</div>
</body>
</html>
